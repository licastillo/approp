<style type="text/css">

  .requerido{
    color:red;
  }
  .m-b-20{
    margin-bottom: 20px;
  }
  .m-t-0{
    margin-top:0px!important;
  }
  .dz-progress {
    display: none !important;
  }
  .dropzone .dz-preview .dz-image{
    border-radius: 0px!important;
  }
  .better-button{
    padding: 5px;
    margin: 0px 15px 20px!important;
  }
  .fileinput-button span{
    margin-left: 5px;
  }
  .m-l-15{
    margin-left: 15px!important;
  }
  table.previews p{
    color: black;
  }
  table > tbody > tr:nth-child(1) > td {
    background-color: rgba(173, 216, 230, 0.53)!important;
  }

  div.previews-wrapper{
    max-height: 300px;
    overflow-y: scroll;
  }
</style>
    <div id="page-content">
      <div class="wide-4">
        <div class="container">
          <div class="explore" style="margin:10px;">
            <h3>Crear Propiedad</h3>

          </div>
          <form id="form-submit" class="form-submit fileupload" action="/properties" method="POST" enctype="multipart/form-data">
            <div class="wide-3">
              <div class="explore">
                <div class="property-map-marker"><img src="/assets/marker-full.png" alt="" /><span class="marker-number">1</span></div>
                <div class="prt-cont">
                  <div class="property-title">
                    <h3>Información principal</h3>
                    <!-- <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and  typesetting industry. </h5> -->
                  </div>
                </div>
              </div>
              <div class="prt-cont">
                <hr>
                <div class="row">
                  <div class="col-md-7 col-sm-7 col-xs-12">
                    <div class="form-group">
                      <label>Título <sup class="requerido">*</sup></label>
                      <input type="text" class="form-control" name="property[titulo]" placeholder="Ingresa el título del anuncio (250 carácteres máximo)" required>
                    </div>

                  </div>


                  <div class="col-md-3 col-sm-3 col-xs-12">
                    <div class="form-group">
                      <label>Precio <sup class="requerido">*</sup></label>
                      <input type="text" class="form-control" placeholder="$" onkeyup="this.value=agregarComas(this.value);" name="property[precio_pesos]" required>
                    </div>
                  </div>
                  <div class="col-md-2 col-sm-2 col-xs-12">
                    <div class="form-group">
                      <label>Moneda <sup class="requerido">*</sup></label>
                      <select class="form-control" name="property[moneda]" required>
                        <option value="CLP">Pesos</option>
                        <option value="UF">UF</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-xs-12">
                    <div class="form-group">
                      <label for="text-area-2">Descripción <sup class="requerido">*</sup></label>
                      <textarea id="text-area-2" rows="6" cols="45" class="form-control" name="property[descripcion]" required></textarea>
                    </div>
                  </div>
                </div>
              </div>
              <div class="explore">
                <div class="property-map-marker"><img src="/assets/marker-full.png" alt="" /><span class="marker-number">2</span></div>
                <div class="prt-cont">
                  <div class="property-title">
                    <h3>Detalles</h3>
                    <!-- <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and  typesetting industry. </h5> -->
                  </div>
                </div>
              </div>
              <div class="prt-cont">
                <hr>
                <div class="row">
                  <div class="col-sm-12">
                    <div class="row">
                      <div class="col-md-6 col-sm-6 col-xs-12">
                        <div class="form-group">
                          <label>Tipo <sup class="requerido">*</sup></label>
                          <select class="form-control" name="property[tipo]">
                            <% Property::TIPOS.each do |p| %>
                              <option value="<%= p[:class_name] %>"><%= p[:name] %></option>
                            <% end %>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6 col-sm-6 col-xs-12">
                        <div class="form-group">
                          <label>Operación <sup class="requerido">*</sup></label>
                          <select class="form-control" name="property[operacion]" required>
                            <% Property.operacions.each do |o| %>
                              <option value=<%= o[0] %>><%= o[0].capitalize.gsub('_',' ') %></option>
                            <% end %>
                          </select>
                        </div>
                      </div>
                    </div>
                    <hr>
                    <div class="row">
                      <div class="col-md-6 col-sm-6 col-xs-12">
                        <div class="form-group">
                          <label>Habitaciones <sup class="requerido">*</sup></label>
                          <input type="text" name="property[habitaciones]" class="form-control" required>
                        </div>
                      </div>
                      <div class="col-md-6 col-sm-6 col-xs-12">
                        <div class="form-group">
                          <label>Baños <sup class="requerido">*</sup></label>
                          <input type="text" name="property[banios]" class="form-control" required>
                        </div>
                      </div>
                    </div>
                    <hr>
                    <div class="row">
                      <div class="col-md-4 col-sm-4 col-xs-12">
                        <div class="form-group">
                          <label>Estacionamiento</label>
                          <select name="property[estacionamiento]" class="form-control">
                            <option value="false">No</option>
                            <option value="true">Si</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4 col-sm-4 col-xs-12">
                        <div class="form-group">
                          <label>Superficie Construida</label>
                          <input type="text" class="form-control" name="property[superficie_construida]" placeholder="En m2" pattern="\d*" >
                        </div>
                      </div>
                      <div class="col-md-4 col-sm-4 col-xs-12">
                        <div class="form-group">
                          <label>Superficie Terreno</label>
                          <input type="text" class="form-control" name="property[superficie_terreno]" placeholder="En m2" pattern="\d*">
                        </div>
                      </div>
                    </div>
                    <hr>
                    <div class="row">
                      <div class="col-md-4 col-sm-4 col-xs-12">
                        <div class="form-group">
                          <label>Condominio</label>
                          <select name="property[condominio]" class="form-control">
                            <option value="false">No</option>
                            <option value="true">Si</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4 col-sm-4 col-xs-12">
                        <div class="form-group">
                          <label>Amoblado</label>
                          <select name="property[amoblado]" class="form-control">
                            <option value="false">No</option>
                            <option value="true">Si</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4 col-sm-4 col-xs-12">
                        <div class="form-group">
                          <label>Bodega</label>
                          <select name="property[bodega]" class="form-control">
                            <option value="false">No</option>
                            <option value="true">Si</option>
                          </select>
                        </div>
                      </div>

                    </div>
                    <hr>
                    <div class="row">
                      <div class="row fileupload-buttonbar">
                        <div class="col-lg-12">
                            <!-- The fileinput-button span is used to style the file input field as button -->
                            <span class="btn btn-success btn-block fileinput-button better-button">
                              <i class="fa fa-camera"></i>
                              <span>Agregar fotos</span>
                              <input type="file" name="property[fotos][]" multiple required>
                            </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-sm-12 previews-wrapper m-b-20">
                    <table role="presentation" class="table table-striped previews"><tbody class="files"></tbody></table>
                  </div>
                </div>
              </div>
              <div class="explore">
                <div class="property-map-marker"><img src="/assets/marker-full.png" alt="" /><span class="marker-number">3</span></div>
                <div class="prt-cont">
                  <div class="property-title">
                    <h3>Ubicación</h3>
                    <!-- <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and  typesetting industry. </h5> -->
                  </div>
                </div>
              </div>
              <div class="prt-cont">
                <hr>
                <div class="row">
                  <div class="location-info col-md-6 col-sm-6 col-xs-12">

                    <div class="input-group">
                      <label>Dirección Referencial <sup class="requerido">*</sup></label>
                      <input type="text" name="property[direccion]" class="form-control" placeholder="Esta es la dirección que mostraremos en el anuncio" required>
                    </div>

                    <div class="input-group">
                      <div class="checkbox"><label><input type="checkbox" class="aprox" name="property[direccion_aprox]"> Mostrar dirección aproximada</label></div>
                    </div>

                  </div>
                  <div class="location-map col-md-6 col-sm-6 col-xs-12">
                    <div class="input-group">
                      <label for="address-map">Dirección exacta</label>
                      <input type="text" class="form-control" id="address-map" name="property[direccion_completa]" placeholder="Ingresa una dirección">
                      <i class="fa fa-search"></i>
                    </div>
                    <div id="submit-map"></div>
                    <div class="row" style="display:none">
                      <div class="col-md-6 col-sm-6 col-xs-12">
                        <div class="form-group">
                          <label for="latitude">Coordinates</label>
                          <input type="text" class="form-control" placeholder="Latitude" name="property[lat]" id="latitude">
                        </div>
                      </div>
                      <div class="col-md-6 col-sm-6 col-xs-12">
                        <div class="form-group">
                          <label for="longitude">&nbsp;</label>
                          <input type="text" class="form-control" placeholder="Longitude" id="longitude" name="property[lng]">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- <div class="explore">
                <div class="property-map-marker"><img src="/assets/marker-full.png" alt="" /><span class="marker-number">4</span></div>
                <div class="prt-cont">
                  <div class="property-title">
                    <h3>Media Files</h3>
                    <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and  typesetting industry. </h5>
                  </div>
                </div>
              </div>
              <div class="prt-cont media">
                <hr>
                <div class="row">
                  <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="featured-image-block">
                      <img src="/assets/files.png" alt="" class="property-icon files">
                      <h3> Add Files</h3>
                      <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and</h5>
                      <input id="file-upload-2" type="file" class="file" required multiple data-show-upload="false" data-show-caption="false" data-show-remove="false" accept="doc/txt,doc/doc" data-browse-class="btn btn-default" data-browse-label="Add Files">
                      <label for="file-upload-2">
                        <img src="/assets/upload.png" alt="" class="image-upload-icon">Add Files
                      </label>
                    </div>
                  </div>
                  <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="featured-image-block">
                      <img src="/assets/gallery.png" alt="" class="property-icon gallery">
                      <h3> Photo Gallery</h3>
                      <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and</h5>
                      <input id="file-upload-3" type="file" class="file" required multiple data-show-upload="false" data-show-caption="false" data-show-remove="false" accept="image/jpeg,image/png" data-browse-class="btn btn-default" data-browse-label="Add Files">
                      <label for="file-upload-3">
                        <img src="/assets/upload.png" alt="" class="image-upload-icon">Add Files
                      </label>
                    </div>
                  </div>
                  <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="featured-image-block">
                      <img src="/assets/plan.png" alt="" class="property-icon plan">
                      <h3> Floor Plans</h3>
                      <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and</h5>
                      <input id="file-upload-4" type="file" class="file" required multiple data-show-upload="false" data-show-caption="false" data-show-remove="false" accept="image/jpeg,image/png" data-browse-class="btn btn-default" data-browse-label="Add Files">
                      <label for="file-upload-4">
                        <img src="/assets/upload.png" alt="" class="image-upload-icon">Add Files
                      </label>
                    </div>
                  </div>
                </div>
                <div class="input-group">
                  <label>Video Presentation</label>
                  <input type="text" class="form-control" placeholder="Add link to your video">
                </div>
                <span class="ffs-bs"><a href="#" class="btn btn-small btn-primary">Add Video</a></span>
              </div> -->
              <div class="explore">
                <div class="property-map-marker"><img src="/assets/marker-full.png" alt="" /><span class="marker-number">4</span></div>
                <div class="prt-cont">
                  <div class="property-title">
                    <h3>Características de la Propiedad</h3>
                    <!-- <h5 class="team-color">Lorem Ipsum is simply dummy text of the printing and  typesetting industry. </h5> -->
                  </div>
                </div>
              </div>
              <div class="prt-cont features">
                <hr>
                <div class="row">
                  <div id="property-features" class="block">
                    <div class="row">
                      <ul class="submit-features">
                        <% Property::CARACTERISTICAS.each do |c| %>
                          <li class="col-md-4 col-sm-4 col-xs-6"><div class="checkbox"><label><input type="checkbox" name="property[caracteristicas][]" value="<%= c.parameterize %>"><%= c %></label></div></li>
                        <% end %>


                      </ul>
                    </div>
                    <hr>
                    <div class="row m-b-20">
                      <button type="submit" class="btn btn-block btn-success m-t-0">Crear Propiedad</button>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

<% content_for :javascript do %>
  <script id="template-upload" type="text/x-tmpl">
  {% for (var i=0, file; file=o.files[i]; i++) { %}
      <tr class="template-upload fade">
          <td>
              <span class="preview"></span>
          </td>
          <td>
              <p class="name">{%=file.name%}</p>
              <strong class="error text-danger"></strong>
          </td>
          <td>
              <p class="size">Processing...</p>
          </td>
          <td>
            {% if (!i) { %}
                <button class="btn btn-danger cancel better-button">
                    <i class="fa fa-ban"></i>
                    <span>Eliminar</span>
                </button>
            {% } %}
          </td>
      </tr>
  {% } %}
  </script>

  <script id="template-download" type="text/x-tmpl">
  {% for (var i=0, file; file=o.files[i]; i++) { %}
      <tr class="template-download fade">
          <td>
              <span class="preview">
                  {% if (file.thumbnailUrl) { %}
                      <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                  {% } %}
              </span>
          </td>
          <td>
              <p class="name">
                  {% if (file.url) { %}
                      <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                  {% } else { %}
                      <span>{%=file.name%}</span>
                  {% } %}
              </p>
              {% if (file.error) { %}
                  <div><span class="label label-danger">Error</span> {%=file.error%}</div>
              {% } %}
          </td>
          <td>
              <span class="size">{%=o.formatFileSize(file.size)%}</span>
          </td>
          <td>
              {% if (file.deleteUrl) { %}
                  <button class="btn btn-danger delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                      <i class="glyphicon glyphicon-trash"></i>
                      <span>Delete</span>
                  </button>
                  <input type="checkbox" name="delete" value="1" class="toggle">
              {% } else { %}
                  <button class="btn btn-warning cancel">
                      <i class="glyphicon glyphicon-ban-circle"></i>
                      <span>Cancel</span>
                  </button>
              {% } %}
          </td>
      </tr>
  {% } %}
  </script>

  <script type="text/javascript">
    var _latitude = -33.5346575;
    var _longitude = -70.5957313;
    google.maps.event.addDomListener(window, 'load', initSubmitMap(_latitude,_longitude));
    function initSubmitMap(_latitude,_longitude){
      var mapCenter = new google.maps.LatLng(_latitude,_longitude);
      var mapOptions = {
        zoom: 14,
        center: mapCenter,
        disableDefaultUI: false,
        scrollwheel: false
      };
      var mapElement = document.getElementById('submit-map');
      window.map = new google.maps.Map(mapElement, mapOptions);
      $('#submit-map').removeClass('fade-map');

      //Autocomplete
      var input = /** @type {HTMLInputElement} */( document.getElementById('address-map') );
      var options = {
        componentRestrictions: {country: 'cl'}
      };
      window.autocomplete = new google.maps.places.Autocomplete(input,options);
      autocomplete.bindTo('bounds', map);
      google.maps.event.addListener(autocomplete, 'place_changed', function() {
        var place = autocomplete.getPlace();
        if (!place.geometry) {
          return;
        }
        if (place.geometry.viewport) {
          map.fitBounds(place.geometry.viewport);
        } else {
          map.setCenter(place.geometry.location);
          map.setZoom(15);
        }

        window.lat = place.geometry.location.lat()
        window.lng = place.geometry.location.lng()

        if(window.aprox){
          removeMarker()
          drawCircle()
        }else{
          drawMarker()
          removeCircle()
        }

        $('#latitude').val( window.lat );
        $('#longitude').val( window.lng );

        var address = '';
        if (place.address_components) {
          address = [
          (place.address_components[0] && place.address_components[0].short_name || ''),
          (place.address_components[1] && place.address_components[1].short_name || ''),
          (place.address_components[2] && place.address_components[2].short_name || '')
          ].join(' ');
        }
      });
    }
    function agregarComas(num){
       return num.replace(/,/g,"").toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function success(position) {
      initSubmitMap(position.coords.latitude, position.coords.longitude);
      $('#latitude').val( position.coords.latitude );
      $('#longitude').val( position.coords.longitude );
    }
    function setup(){
      $("input[name='property[titulo]']").val('titulo')
      $("input[name='property[precio_pesos]']").val('1234567')
      $("textarea[name='property[descripcion]']").val('descripcion')
      $("input[name='property[habitaciones]']").val(3)
      $("input[name='property[banios]']").val(4)
      $("input[name='property[superficie_construida]']").val(123)
      $("input[name='property[superficie_terreno]']").val(1234)
      $("input[name='property[direccion]']").val('Curico 385')
    }

    function removeMarker(){
      if(window.marker){
        window.marker.setMap(null)
      }

    }

    function removeCircle(){
      if(window.circle){
        window.circle.setMap(null)
      }
    }

    function drawCircle(){
      window.circle = new google.maps.Circle({
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: '#FF0000',
        fillOpacity: 0.35,
        map: window.map,
        center: {lat: window.lat, lng: window.lng},
        radius: 200
      });
    }

    function drawMarker(){

      window.marker = new google.maps.Marker({
        position: {lat: window.lat, lng: window.lng},
        map: window.map,
        icon: '/assets/marker-full.png'
      });

      marker.setPosition({lat: window.lat, lng: window.lng});
      marker.setVisible(true);
    }

    $(document).ready(function() {

      window.aprox = false

      $('.fileupload').fileupload({
        replaceFileInput: false
      })

      $('.aprox').on('ifChecked', function(event) {
        window.aprox = true
        if(window.lat && window.lng){
          removeMarker()
          drawCircle()
        }
      });

      $('.aprox').on('ifUnchecked', function(event) {
        window.aprox = false
        if(window.lat && window.lng){
          removeCircle()
          drawMarker()
        }
      });

      <% if !Rails.env.production? %>
        setup()
      <% end %>
    });
  </script>
<% end %>
